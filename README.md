Торговый помощник (Telegram-бот для инвестиций через Tinkoff API)

Описание проекта: Этот проект представляет собой автоматизированного торгового помощника с интерфейсом Telegram-бота, предназначенного для работы с инвестициями через Tinkoff Invest API. Бот отслеживает биржевые инструменты по заданной стратегии и отправляет сигналы о важных событиях – например, о пробитии ценовых уровней или необходимости закрыть позицию. Пользователь взаимодействует с ботом через команды в Telegram, получая уведомления в реальном времени о торговых сигналах и управляя списком отслеживаемых инструментов. Проект написан на Python и использует современные технологии (asyncio) для обеспечения асинхронной работы с API Tinkoff, базой данных и Telegram.

Возможности

Генерация торговых сигналов на основе стратегии Donchian Channel + ATR: Бот реализует классическую стратегию каналов Дончиана (длинный канал 55 дней и короткий канал 20 дней) в сочетании с индикатором Average True Range (ATR, 14). На основе этой стратегии отслеживаются пробои ценовых каналов:

Пробой верхней границы 55-дневного канала генерирует сигнал на открытие длинной позиции (лонг).

Пробой нижней границы 20-дневного канала генерирует сигнал на открытие короткой позиции (шорт).

Стоп-сигналы по позиции: после открытия позиции бот контролирует цену относительно 20-дневного канала: при падении цены ниже нижней границы 20-дневного канала для лонга (или росте выше верхней границы 20-дневного канала для шорта) генерируется сигнал на выход из позиции (стоп-лосс). Индикатор ATR рассчитывается для оценки волатильности инструмента и может использоваться для информирования о размерах стоп-лосса или просто предоставляется в данных.

Мониторинг рынка и уведомления в Telegram: Помощник подключается к стриму рыночных данных Tinkoff (через Streaming API) и постоянно отслеживает изменение цен по выбранным инструментам. Все сигналы (пробои уровней, срабатывание стоп-условий) мгновенно отправляются пользователю в виде сообщений в чате Telegram. Уведомления содержат информацию об инструменте, текущей цене, направлении сигнала (лонг/шорт) и причинах (например, пробой канала или ATR).

Управление списком отслеживаемых инструментов: Пользователь может добавлять интересующие его инструменты для мониторинга и также удалять их из списка через команды бота. Бот интегрируется с аккаунтом Tinkoff Инвестиции пользователя – можно выбрать инструменты из списка “Избранное” в аккаунте Tinkoff для быстрого добавления. Также бот учитывает открытые позиции пользователя: инструменты, по которым у пользователя уже есть позиции, могут отслеживаться автоматически.

Поддержка аккаунта Tinkoff: Через команду bot’а можно подключить свой брокерский аккаунт Tinkoff. Это позволяет боту получить список ваших счетов и портфелей. Выбрав нужный аккаунт, бот сохраняет его, чтобы в дальнейшем использовать информацию о ваших текущих позициях (например, чтобы не дублировать сигналы для уже открытых позиций или отслеживать их состояние).

Telegram-интерфейс (команды бота): Бот реагирует на ряд команд, позволяющих управлять его работой:

/start – запуск и приветствие от бота, отображение стартового сообщения (а также идентификатора чата, необходимого для конфигурации).

/help – вывод справки по доступным командам и возможностям бота.

/add_account_check – подключение инвестиционного аккаунта Tinkoff. Бот выведет список ваших счетов, и после выбора сохранит аккаунт для мониторинга.

/add_instruments_for_check – добавление инструментов для отслеживания. Бот получит из Tinkoff ваш список “Избранных” инструментов и предложит через интерактивное меню выбрать, какие из них нужно начать мониторить. Выбранные инструменты сохраняются в базе данных, по ним сразу рассчитываются индикаторы (Donchian 55/20, ATR) и запускается стрим котировок.

/uncheck_instruments – удаление (отписка) инструментов из мониторинга. Бот покажет текущий список отслеживаемых инструментов и позволит отметить, которые больше не нужно отслеживать. После подтверждения эти инструменты будут убраны из базы, и бот отключится от стрима их цен.

(При необходимости бот может быть расширен и другими командами, например, для отображения текущего состояния отслеживаемых инструментов, но основные команды перечислены выше.)

Установка и запуск

Проект можно запустить локально (в среде Python) или с использованием Docker-контейнеров. Ниже представлены оба варианта.

1. Локальный запуск (Poetry)

Для управления зависимостями используется Poetry. Убедитесь, что у вас установлены Python версии 3.13+ и Poetry.

Шаги установки:

Склонируйте репозиторий с кодом проекта:

git clone <URL_репозитория> tinkoff-bot
cd tinkoff-bot


Установите зависимости проекта через Poetry:

poetry install


Это создаст изолированное окружение и установит все необходимые библиотеки (aiogram, tinkoff-investments SDK, SQLAlchemy и др.).

Настройте конфигурацию. Перед первым запуском необходимо задать ключевые параметры (токены и прочее). Это можно сделать с помощью файла конфигурации (например, config.yaml) или через переменные окружения. Проще всего создать в корне проекта файл config.yaml со следующим содержимым:

tinkoff-client:
  token: "ВАШ_ТОКЕН_TINKOFF_API"
tg-bot:
  token: "ВАШ_ТОКЕН_TELEGRAM_BOT"
  chat_id: ВАШ_CHAT_ID
db-pgsql:
  address: "postgresql+asyncpg://postgres:postgres@localhost:5437/data_positions"
scheduler-trading:
  start: "09:50"
  close: "18:40"


В этом файле:

tinkoff-client.token – токен для доступа к Tinkoff Invest API (его можно получить в личном кабинете Tinkoff).

tg-bot.token – токен вашего Telegram-бота (получается у BotFather).

tg-bot.chat_id – идентификатор чата Telegram, в который бот будет слать уведомления. (Совет: запустите бота и используйте команду /start – в приветственном сообщении бот выведет ваш chat_id, который вы можете скопировать сюда.)

db-pgsql.address – URL подключения к базе данных PostgreSQL. В примере используется локальное подключение к БД, поднятой через Docker (см. ниже): пользователь postgres, пароль postgres, база data_positions на порту 5437. Вы можете изменить строку подключения согласно вашим настройкам базы.

scheduler-trading.start и scheduler-trading.close – время (МСК) начала и окончания торгового дня, в формате ЧЧ:ММ. В эти времена бот автоматически запускает или останавливает получение рыночных данных. В примере указаны 09:50 (за 10 минут до открытия основного рынка) и 18:40 (время закрытия основных торгов на Московской бирже).

Настройте базу данных. Проект использует PostgreSQL для хранения данных. Необходимо:

Установить PostgreSQL локально или запустить контейнер с БД через Docker (см. ниже раздел про Docker).

Создать базу данных с именем, указанным в конфиге (например, data_positions). Если вы используете прилагаемый docker-compose.yml, база будет создана автоматически.

Убедиться, что параметры подключения (адрес, порт, логин, пароль) соответствуют указанным в config.yaml.

Запустите бота. Выполните команду:

poetry run python main.py --config config.yaml


Бот загрузит конфигурацию, подключится к базе данных, инициализирует все сервисы (Telegram, Tinkoff API, планировщик задач). В консоли вы будете видеть логи работы. Теперь можете открыть чат с вашим ботом в Telegram и отправить команду /start для начала работы.

Примечание: При первом запуске таблицы в базе данных будут созданы автоматически с помощью SQLAlchemy (ORM создаёт необходимые таблицы, такие как accounts и instruments). Убедитесь, что указанный пользователь базы данных имеет права на создание таблиц.

2. Запуск с помощью Docker

Для удобства развертывания, особенно в продакшене, можно использовать Docker. В репозитории есть файл docker-compose.yml, предназначенный для быстрого запуска PostgreSQL. Вы можете расширить его для запуска и самого бота. Ниже приведены основные шаги:

Запуск базы данных в Docker: Убедитесь, что Docker установлен, и выполните команду:

docker-compose up -d


Это поднимет контейнер PostgreSQL 15 с именем Instrument (как указано в docker-compose). Параметры БД внутри контейнера:

База данных: data_positions

Пользователь: postgres

Пароль: postgres

Порт на хосте: 5437 (проброшен на стандартный порт 5432 внутри контейнера)

Данные БД будут сохранены в Docker volume positions_tinkoff_volume (чтобы не потерять их при пересоздании контейнера).

Конфигурация среды для бота: Так же, как и в случае локального запуска, необходимо предоставить боту токены и настройки. В среде Docker это удобно сделать через переменные окружения или файл .env. Пример переменных:

TINKOFF_TOKEN=<ваш Tinkoff API токен>
TG_BOT_TOKEN=<токен вашего Telegram-бота>
TG_CHAT_ID=<ID вашего чата Telegram>
DB_PGSQL_ADDRESS=postgresql+asyncpg://postgres:postgres@db:5432/data_positions
SCHEDULER_START=09:50
SCHEDULER_CLOSE=18:40


Если вы используете docker-compose.yml, можно добавить сервис бота, передав эти переменные (либо подключив .env файл):

services:
  bot:
    build: .
    image: tinkoff-bot:latest
    env_file: .env
    depends_on:
      - db
    networks:
      - tinkoff_tgbot


(В данном примере предполагается, что у вас подготовлен Dockerfile для сборки образа бота. Он должен скопировать код проекта и запустить python main.py.)

Запуск бота в контейнере: Если у вас настроен образ, запустите:

docker-compose up -d bot


Это запустит контейнер с ботом, который будет подключаться к базе данных db (PostgreSQL), поднятой на предыдущем шаге. Убедитесь, что в переменной DB_PGSQL_ADDRESS хост указан как db (имя сервиса Postgres в docker-compose) и порт 5432 – внутри docker-сети.

Проверка работы: После запуска контейнеров убедитесь по логам (docker-compose logs -f bot), что бот успешно стартовал. Затем в Telegram отправьте команду /start вашему боту, чтобы убедиться, что связь установлена.

Если вы не желаете помещать бота в отдельный контейнер, вы можете комбинировать способы: например, запустить только базу данных через Docker, а сам бот – локально через Poetry, указав DB_PGSQL_ADDRESS на localhost:5437.

Переменные окружения

Ниже перечислены необходимые переменные окружения (либо соответствующие поля в конфигурационном файле), которые нужно задать для работы бота:

TINKOFF_TOKEN – токен доступа к Tinkoff Invest API. Обязателен для выполнения запросов к инвестиционной системе Tinkoff (получение котировок, портфеля и т.д.).

TG_BOT_TOKEN – токен Telegram-бота. Необходим для подключения к Bot API и получения/отправки сообщений.

TG_CHAT_ID – числовой ID Telegram-чата, в который бот будет слать уведомления. Обычно это ID вашего аккаунта (если вы общаетесь с ботом напрямую) или группы, если бот добавлен в группу.

DB_PGSQL_ADDRESS – строка подключения к базе PostgreSQL. Формат: postgresql+asyncpg://<user>:<password>@<host>:<port>/<dbname>. Например: postgresql+asyncpg://postgres:postgres@localhost:5437/data_positions. При использовании Docker-compose рекомендуется использовать: postgresql+asyncpg://postgres:postgres@db:5432/data_positions (где db – имя контейнера/сервиса с Postgres).

SCHEDULER_START – время начала торгов (строка в формате "HH:MM", часовой пояс – Москва/MSK), когда бот должен запускать поток рыночных данных. Например, "09:50" (за несколько минут до открытия рынка).

SCHEDULER_CLOSE – время окончания торгов, для автоматического выключения потокового получения данных. Например, "18:40" (после закрытия основного торгового дня).

Эти переменные можно задать через файл конфигурации config.yaml (как показано выше) или напрямую как переменные окружения системы (особенно удобно при запуске в Docker). Без указания этих параметров бот не сможет подключиться к необходимым сервисам.

Стек технологий

Внутри проекта используются следующие основные технологии и библиотеки:

Python 3.13+ & asyncio: основа проекта – язык Python с активным использованием асинхронного программирования (async/await) для одновременной работы с сетью (API, Telegram) и БД.

FastAPI: современный высокопроизводительный web-фреймворк Python. В данном проекте архитектура сервиса организована на его основе (приложение запускается как асинхронный сервис, готовый к возможному расширению REST API на FastAPI в будущем).

Aiogram 3: библиотека для создания Telegram-ботов на Python. Обеспечивает удобную обработку команд, состояний (FSM) и интеграцию с asyncio. В проекте aiogram используется для реализации логики бота: команды, хэндлеры сообщений/колбэков, отправка уведомлений.

Tinkoff Invest API: официальное API Тинькофф Инвестиций для получения рыночных данных и управления счетом. Проект использует SDK tinkoff-investments (асинхронный клиент) для подключения к стриму котировок, получения исторических свечей, списка аккаунтов/портфеля и списка “избранных” инструментов пользователя.

PostgreSQL: реляционная СУБД для хранения данных. В базе данных сохраняются: информация об инвестиционных счетах пользователя, список отслеживаемых инструментов, рассчитанные индикаторы (Donchian 20/55, ATR), флаги активных позиций и пр. Используется для устойчивого хранения между запусками бота.

SQLAlchemy 2 (Async ORM): объектно-реляционное отображение для работы с PostgreSQL. Используется асинхронный движок (asyncpg) и декларативные модели. Код определяет модели Account и Instrument и выполняет запросы (SELECT, INSERT, UPDATE) через repository класс. Это обеспечивает удобную работу с БД без прямого написания SQL.

APScheduler: планировщик задач для Python. Применяется для автоматического запуска и остановки потокового получения данных по расписанию. С помощью APScheduler настроены ежедневные задачи:

Запуск стрима данных и обновление индикаторов в определенное время утром (SCHEDULER_START).

Отключение стрима и сохранение состояния в указанное время вечером (SCHEDULER_CLOSE).

Pydantic: используется для валидации и структурирования конфигурации (класс Config описывает необходимую структуру config.yaml) и для приведения данных, полученных из API, к удобным объектам (например, Enums для направлений позиций).

Aiogram FSM (Finite State Machine): для реализации пошаговых взаимодействий с пользователем в чате. Например, выбор аккаунта или выбор нескольких инструментов из списка реализованы через FSM (состояния AddAccount, SetFavorites, RemoveFavorites), что улучшает пользовательский опыт.

Логирование: Встроенное логирование через модуль logging (обертка в utils/logger.py) помогает отслеживать работу бота, выводит отладочную информацию о получаемых рыночных данных, отправляемых сообщениях, ошибках подключения и т.д.

(Помимо вышеперечисленных, проект также использует мелкие утилиты, например, argparse для парсинга аргумента командной строки, pyyaml для чтения YAML-конфига, hvac для потенциальной интеграции с HashiCorp Vault при работе с секретами, и др.)

Структура проекта

Исходный код организован по модулям для ясности и расширяемости. Ниже приведена упрощённая структура каталогов и файлов проекта:

tinkoff-bot/                # Корневая директория проекта
├── bots/                  # Модули, связанные с Telegram-ботом
│   └── tg_bot/
│       ├── handlers/      # Обработчики сообщений и команд бота (команды /start, /help, добавление/удаление инструментов и т.д.)
│       ├── keyboards/     # Определения inline-клавиатур для интерактивных меню бота (выбор аккаунта, инструментов)
│       ├── messages/      # Тексты сообщений и шаблоны ответов, отправляемых ботом
│       └── middlewares/   # Промежуточные слои (middleware) для бота – например, внедрение зависимостей (клиента API, БД) в хендлеры
├── clients/               # Взаимодействие с внешними API
│   └── tinkoff/           # Клиент для Tinkoff Invest API
│       ├── client.py      # Класс TClient: реализует подключение к Tinkoff API, получение аккаунтов, портфеля, стриминг рыночных данных
│       └── ...            # Дополнительные файлы (например, тесты, лог-файлы, вспомогательные JSON с инструментами)
├── core/                  # Ядро системы и бизнес-логика
│   ├── domains/           # Доменные сущности и события
│   │   └── event_bus.py   # Реализация шины событий (StreamBus) для асинхронной обработки рыночных данных (pub/sub между TClient и обработчиком MarketDataProcessor)
│   └── schemas/           # Логика обработки входящих данных (схемы/процессоры)
│       └── stream_processor.py  # Класс MarketDataProcessor: подписывается на события StreamBus и реагирует на рыночные данные (LastPrice, свечи, и т.п.), генерирует торговые сигналы и уведомления
├── database/              # Модуль работы с базой данных (PostgreSQL)
│   └── pgsql/
│       ├── models.py      # Определение ORM-моделей (таблицы accounts и instruments, с полями для тикера, флагов, значений индикаторов и т.д.)
│       ├── enums.py       # Определения перечислений, напр. направление позиции (Direction: LONG/SHORT)
│       └── repository.py  # Класс Repository: содержит асинхронные методы для взаимодействия с БД (добавление/обновление инструментов, получение списка, пометка сигналов как отправленных и др.)
├── services/              # Сервисы, реализующие фоновые задачи и расчёты
│   ├── historic_service/  
│   │   └── historic_service.py  # Класс IndicatorCalculator: вычисление индикаторов Donchian Channel и ATR на основе исторических данных (например, расчёт 55-дневного максимума/минимума, ATR(14))
│   └── scheduler/
│       └── scheduler.py   # Настройка планировщика (APScheduler): содержит конфигурацию часового пояса, функции для парсинга времени и, возможно, дополнительные задания
├── utils/                 # Утилиты и вспомогательные модули
│   ├── arg_parse.py       # Парсинг аргументов командной строки (опция --config для указания пути к конфигу)
│   ├── logger.py          # Настройка логгера (формат логов, уровень и т.д.)
│   └── utils.py           # Различные вспомогательные функции
├── config.py              # Описание структуры конфигурационного файла с помощью Pydantic (классы Config, TinkoffClient, TgBot, DbPsql, SchedulerTrading)
├── main.py                # Главный исполняемый файл приложения. Инициализирует все компоненты и запускает бота.
├── docker-compose.yml     # Docker-compose конфигурация (PostgreSQL база данных). Можно дополнить для контейнера бота.
├── pyproject.toml         # Конфигурация Poetry: список зависимостей, метаданные проекта.
└── poetry.lock            # Зафиксированные версии зависимостей для воспроизводимости окружения.


Каждый модуль выполняет свою роль:

bots/tg_bot/… – отвечает за взаимодействие с пользователем через Telegram. Здесь описаны команды и диалоги, формируются сообщения и меню, бот отправляет уведомления о сигналах.

clients/tinkoff/… – отвечает за взаимодействие с API Тинькофф. Класс TClient инкапсулирует логину/подключение к API, получение данных (аккаунты, портфель, избранное, исторические свечи) и управление стримингом цен. Через него бот получает всю информацию о рынках и счёте.

core/… – содержит обобщенную логику обработки данных. event_bus.py реализует паттерн “шина событий” (pub/sub) для передачи входящих рыночных данных от Tinkoff API к обработчику. stream_processor.py (MarketDataProcessor) получает эти события (например, обновления цен) и, опираясь на данные из БД (последние рассчитанные уровни Дончиана, ATR, флаги состояний), принимает решения: нужно ли отправить сигнал пользователю, нужно ли обновить статус позиции и т.п. Также, MarketDataProcessor формирует текст уведомления (используя шаблоны из messages_const) и отправляет сообщение через bot.send_message.

database/… – все, что связано с хранением данных. models.py описывает таблицы:

Account (инвестиционные счета пользователя, хранит ID и название счета, флаг активности и пр.);

Instrument (отслеживаемые инструменты, хранит идентификатор инструмента на стороне Tinkoff, тикер, рассчитанные значения donchian_long_55, donchian_short_20 и т.д., флаги in_position – есть ли открытая позиция, direction – направление позиции, check – флаг отслеживания, to_notify – флаг отправки сигнала).
Repository предоставляет методы, например: get_instruments() (список всех отслеживаемых инструментов), add_instrument_or_update() (добавить новый инструмент или обновить показатели существующего), notify_to_true/false (пометить, что по инструменту нужно/не нужно отправлять новый сигнал), get_indicators_by_uid() (получить значения индикаторов по инструменту для проверки условий).

services/… – фоновые сервисы и задачи:

historic_service.py: метод IndicatorCalculator.build_instrument_update() на основе загруженных исторических данных рассчитывает словарь с новыми значениями индикаторов (максимумы/минимумы за 55 и 20 дней, ATR14). Эти данные потом сохраняются в БД для каждого инструмента.

scheduler.py: задаёт параметры планировщика и содержит утилиты для работы со временем (например, TZ_DEFAULT – часовой пояс, parse_hhmm – разбор строки времени типа "09:50"). Планировщик (AsyncIOScheduler) настраивается и запускается в main.py: добавляются ежедневные задания open_if_needed и close_and_stop на соответствующие времена из конфига. Эти задания запускают/останавливают поток рыночных данных через методы Service: _job_open_if_needed вызывает TClient.start() (подключиться к стриму) и обновление индикаторов, а _job_close_and_stop – останавливает стрим.

utils/… – различные вспомогательные части:

arg_parse.py использует argparse для чтения аргумента командной строки --config (путь до YAML-файла конфигурации; опционально, по умолчанию ищется config.yaml).

logger.py задаёт конфигурацию логирования (например, формат сообщения, уровень логов DEBUG/INFO).

utils.py может содержать прочие небольшие полезные функции (например, преобразования, форматирование и т.п.).

main.py – точка входа приложения. Здесь происходит сборка всех компонентов воедино:

Чтение конфигурации (парсинг YAML в объект Config).

Инициализация Repository (подключение к БД).

Создание экземпляра TClient для работы с Tinkoff API (передаётся токен и шина событий).

Настройка Telegram Bot (Bot и Dispatcher из aiogram) – регистрируются middleware (внедрение tclient и db в контекст) и маршруты (handlers) для команд.

Создание MarketDataProcessor и подписка его на события стрима (StreamBus.subscribe('market_data_stream', processor.execute)).

Настройка APScheduler: добавление заданий на открытие/закрытие рынка согласно Config.

Запуск основных служб: stream_bus.start(), scheduler.start(), выполнение первоначальной задачи открытия (_job_open_if_needed) и обновления индикаторов, после чего – запуск бесконечного цикла dp.start_polling() для обработки сообщений Telegram.

Корректное завершение работы (при остановке программы) через service.stop(): останавливается планировщик, закрывается стрим Tinkoff, завершается сессия Telegram Bot API, отключается шина событий.

Конфигурационные файлы и прочее: docker-compose.yml содержит только сервис БД (PostgreSQL) и сеть; pyproject.toml и poetry.lock фиксируют версии используемых библиотек (например, aiogram 3.22, tinkoff-investments 0.2.x beta, SQLAlchemy 2.x, APScheduler 3.11, psycopg2/asyncpg для БД, Pydantic, и др.), а также метаданные проекта (название, версия, автор).

Спасибо за использование Tinkoff Invest Trading Bot! Если у вас возникли вопросы или проблемы с запуском, обратитесь к разделу /help в боте или проверьте конфигурацию по шагам, описанным выше. Удачных инвестиций!